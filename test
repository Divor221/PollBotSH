import asyncio
import logging
import os
import json
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from aiogram.types import BotCommand

load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")
GROUP_ID = os.getenv("GROUP_ID")
ALLOWED_USER_ID_ENV = os.getenv("ALLOWED_USER_ID")

if not TOKEN:
    raise ValueError("BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
if not GROUP_ID:
    raise ValueError("GROUP_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

try:
    GROUP_ID = int(GROUP_ID)
except ValueError:
    raise ValueError("GROUP_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")

try:
    ALLOWED_USER_ID = int(ALLOWED_USER_ID_ENV)
except ValueError:
    raise ValueError("ALLOWED_USER_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")

bot = Bot(token=TOKEN)
storage = MemoryStorage()
dp = Dispatcher(storage=storage)
scheduler = AsyncIOScheduler(timezone="Europe/Moscow")

# ==================== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥ –≤ –º–µ–Ω—é ====================
async def set_commands(bot: Bot):
    commands = [
        BotCommand(command="start", description="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"),
        BotCommand(command="set_days", description="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–Ω–∏ –æ–ø—Ä–æ—Å–æ–≤"),
        BotCommand(command="list_days", description="–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"),
        BotCommand(command="remove_days", description="–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ"),
        BotCommand(command="help", description="–ü–æ–º–æ—â—å")
    ]
    await bot.set_my_commands(commands)

# ==================== Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ ====================

class AccessMiddleware:
    """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í aiogram 3.x –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —Å–∞–º –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è (Message –∏–ª–∏ CallbackQuery)."""
    
    async def __call__(self, handler, event, data):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ–±—ã—Ç–∏—è"""
        # event ‚Äî —ç—Ç–æ Message –∏–ª–∏ CallbackQuery, —É –æ–±–æ–∏—Ö –µ—Å—Ç—å from_user
        user_id = getattr(event.from_user, "id", None)
        
        if user_id is None:
            return await handler(event, data)
        
        if user_id != ALLOWED_USER_ID:
            logging.warning(f"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
            try:
                # CallbackQuery.answer(show_alert=True) ‚Äî –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ; Message.answer() ‚Äî –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if isinstance(event, CallbackQuery):
                    await event.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.", show_alert=True)
                else:
                    await event.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
            except Exception as e:
                logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç–∫–∞–∑–µ –¥–æ—Å—Ç—É–ø–∞: {e}")
            return
        
        return await handler(event, data)

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
dp.message.middleware(AccessMiddleware())
dp.callback_query.middleware(AccessMiddleware())

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
CONFIG_FILE = "schedule_config.json"
MINUTES_OPTIONS = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55]
HOURS_RANGE = range(10, 20)  # –ß–∞—Å—ã —Å 10 –¥–æ 20

# –ú–∞–ø–ø–∏–Ω–≥ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏

DAY_NAMES_RU = {
    'mon': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 'tue': '–í—Ç–æ—Ä–Ω–∏–∫', 'wed': '–°—Ä–µ–¥–∞', 'thu': '–ß–µ—Ç–≤–µ—Ä–≥',
    'fri': '–ü—è—Ç–Ω–∏—Ü–∞', 'sat': '–°—É–±–±–æ—Ç–∞', 'sun': '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
}

DAY_NAMES = {
    'mon': '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', 'tue': '–í—Ç–æ—Ä–Ω–∏–∫', 'wed': '–°—Ä–µ–¥–∞', 'thu': '–ß–µ—Ç–≤–µ—Ä–≥',
    'fri': '–ü—è—Ç–Ω–∏—Ü–∞', 'sat': '–°—É–±–±–æ—Ç–∞', 'sun': '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'
}
# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
class ScheduleStates(StatesGroup):
    waiting_for_extra_options = State()

# ==================== –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π ====================

def load_config():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞"""
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
            return {}
    return {}

def save_config(config):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ñ–∞–π–ª"""
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")

def get_config():
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π schedules"""
    config = load_config()
    if 'schedules' not in config:
        config['schedules'] = []
    return config

def validate_schedule(schedule):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    return all([
        schedule.get('send_day'),
        schedule.get('poll_day'),
        schedule.get('hour') is not None,
        schedule.get('minute') is not None
    ])

# ==================== –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ====================

async def send_squash_poll(day_name: str, extra_options: list = None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø—Ä–æ—Å –≤ –≥—Ä—É–ø–ø—É"""
    options = ["–î–∞", "–ù–µ—Ç", "–†–µ–∑–µ—Ä–≤"]
    if extra_options:
        options.extend(extra_options)
    options.append("–¢—Ä–µ–Ω–µ—Ä")

    try:
        await bot.send_poll(
            chat_id=GROUP_ID,
            question=f"üìä –°–∫–≤–æ—à –≤ {day_name}?",
            options=options,
            is_anonymous=False
        )
        logging.info(f"–û–ø—Ä–æ—Å –Ω–∞ {day_name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–ø—Ä–æ—Å–∞ ({day_name}): {e}")

async def send_reminder():
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–∏"""
    try:
        await bot.send_message(chat_id=GROUP_ID, text="üîî –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç!")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")

# ==================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º ====================

def clear_scheduler():
    """–û—á–∏—â–∞–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
    scheduler.remove_all_jobs()

def calculate_reminder_time(hour: int, minute: int):
    """–í—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –æ–ø—Ä–æ—Å–∞)"""
    reminder_minute = minute - 5
    reminder_hour = hour
    
    if reminder_minute < 0:
        reminder_minute += 60
        reminder_hour -= 1
        if reminder_hour < 0:
            reminder_hour = 23
    
    return reminder_hour, reminder_minute

def add_schedule(send_day: str, poll_day: str, hour: int, minute: int, extra_options: list = None):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
    job_id = f"poll_{send_day}_{poll_day}"
    scheduler.add_job(
        send_squash_poll,
        'cron',
        day_of_week=send_day,
        hour=hour,
        minute=minute,
        args=[poll_day, extra_options],
        id=job_id,
        replace_existing=True
    )
    logging.info(f"–î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –æ–ø—Ä–æ—Å –Ω–∞ {poll_day}, –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ {DAY_NAMES_RU.get(send_day, send_day)}")

def update_reminder_schedule():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø—Ä–æ—Å–æ–≤"""
    config = get_config()
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    jobs = scheduler.get_jobs()
    for job in jobs:
        if job.id.startswith('reminder_'):
            try:
                scheduler.remove_job(job.id)
            except Exception as e:
                logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É {job.id}: {e}")
    
    # –°–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–ø—Ä–æ—Å–∞
    for schedule in config.get('schedules', []):
        if not validate_schedule(schedule):
            continue
        
        send_day = schedule.get('send_day')
        poll_day = schedule.get('poll_day')
        hour = schedule.get('hour')
        minute = schedule.get('minute')
        
        reminder_hour, reminder_minute = calculate_reminder_time(hour, minute)
        reminder_id = f"reminder_{send_day}_{poll_day}"
        
        scheduler.add_job(
            send_reminder,
            'cron',
            day_of_week=send_day,
            hour=reminder_hour,
            minute=reminder_minute,
            id=reminder_id,
            replace_existing=True
        )

def setup_scheduler():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    clear_scheduler()
    config = get_config()
    
    schedules = config.get('schedules', [])
    if not schedules:
        logging.info("–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /set_days –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")
        return
    
    for schedule in schedules:
        if not validate_schedule(schedule):
            logging.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: {schedule}")
            continue
        
        add_schedule(
            schedule.get('send_day'),
            schedule.get('poll_day'),
            schedule.get('hour'),
            schedule.get('minute'),
            schedule.get('extra_options')
        )
    
    update_reminder_schedule()

def add_schedule_to_config(send_day: str, poll_day: str, hour: int, minute: int, extra_options: list = None):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"""
    config = get_config()
    schedule_id = f"{send_day}_{poll_day}"
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    config['schedules'] = [s for s in config['schedules'] if s.get('id') != schedule_id]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    config['schedules'].append({
        'id': schedule_id,
        'send_day': send_day,
        'poll_day': poll_day,
        'hour': hour,
        'minute': minute,
        'extra_options': extra_options
    })
    
    save_config(config)
    setup_scheduler()

def remove_schedule_from_config(send_day: str, poll_day: str):
    """–£–¥–∞–ª—è–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
    config = get_config()
    schedule_id = f"{send_day}_{poll_day}"
    config['schedules'] = [s for s in config['schedules'] if s.get('id') != schedule_id]
    save_config(config)
    setup_scheduler()

# ==================== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI ====================

DAYS = {
    "mon": "–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫",
    "tue": "–í—Ç–æ—Ä–Ω–∏–∫",
    "wed": "–°—Ä–µ–¥–∞",
    "thu": "–ß–µ—Ç–≤–µ—Ä–≥",
    "fri": "–ü—è—Ç–Ω–∏—Ü–∞",
    "sat": "–°—É–±–±–æ—Ç–∞",
    "sun": "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
}

def create_days_keyboard(callback_prefix: str, back_callback: str = None) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    for code, name in DAYS.items():
        builder.row(InlineKeyboardButton(text=name, callback_data=f"{callback_prefix}_{code}"))
    
    if back_callback:
        builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=back_callback))
        
    return builder.as_markup()

def create_poll_days_keyboard(send_day: str) -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    
    for name in DAYS.values():
        builder.row(InlineKeyboardButton(text=name, callback_data=f"set_poll_{send_day}_{name}"))
    
    builder.row(InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_send_day"))
    
    return builder.as_markup()


def format_schedule_message(send_day: str, poll_day: str, hour: int, minute: int, extra_options: list = None):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏"""
    send_day_name = DAY_NAMES_RU.get(send_day, send_day)
    text = (
        f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!\n\n"
        f"üìÖ –û–ø—Ä–æ—Å –Ω–∞: {poll_day}\n"
        f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤: {send_day_name}\n"
        f"‚è∞ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {hour:02d}:{minute:02d}\n"
    )
    if extra_options:
        options_text = ', '.join(extra_options)
        text += f"üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: {options_text}"
    else:
        text += "üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: –Ω–µ—Ç"
    return text

async def show_extra_options_menu(callback: CallbackQuery, send_day: str, poll_day: str, hour: int, minute: int):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤"""
    send_day_name = DAY_NAMES_RU.get(send_day, send_day)
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤", callback_data="skip_extra_options")],
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã", callback_data="add_extra_options")],
        [InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data=f"back_to_time_{send_day}_{poll_day}"
        )],
    ])
    
    await callback.message.edit_text(
        f"‚úÖ –î–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞: {send_day_name}\n"
        f"‚úÖ –î–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {poll_day}\n"
        f"‚úÖ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {hour:02d}:{minute:02d}\n\n"
        f"–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–ø—Ä–æ—Å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:\n"    
        f"‚ñ™–î–∞\n"                                      
        f"‚ñ™–ù–µ—Ç\n"
        f"‚ñ™–†–µ–∑–µ—Ä–≤\n"
        f"‚ñ™–¢—Ä–µ–Ω–µ—Ä\n"                                                                                          
        f"üìù –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –æ–ø—Ä–æ—Å?\n",
        reply_markup=keyboard
    )

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ ====================

@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ —Å–∫–≤–æ—à—É.\n\n"
        "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/set_days - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–Ω–∏ –¥–ª—è –æ–ø—Ä–æ—Å–æ–≤\n"
        "/list_days - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n"
        "/remove_days - –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
        "/help - –ü–æ–º–æ—â—å"
    )
    await message.answer(text)

@dp.message(Command("help"))
async def cmd_help(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    text = (
        "üìñ –ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞:\n\n"
        "üîπ /set_days - –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ä–æ—Å\n"
        "   –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞ –∏ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n\n"
        "üîπ /list_days - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ \n\n"
        "üîπ /remove_days - –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤\n\n"
    )
    await message.answer(text)

@dp.message(Command("set_days"))
async def cmd_set_days(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–Ω–µ–π"""
    keyboard = create_days_keyboard("set_send")
    await message.answer("üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞:", reply_markup=keyboard)

@dp.message(Command("list_days"))
async def cmd_list_days(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    config = get_config()
    schedules = config.get('schedules', [])
    
    if not schedules:
        await message.answer("üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /set_days –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.")
        return
    
    text = "üìã –¢–µ–∫—É—â–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:\n\n"
    for schedule in schedules:
        if not validate_schedule(schedule):
            continue
            
        send_day = DAY_NAMES_RU.get(schedule.get('send_day'), schedule.get('send_day'))
        poll_day = schedule.get('poll_day')
        hour = schedule.get('hour')
        minute = schedule.get('minute')
        extra_options = schedule.get('extra_options')
        
        text += f"üìÖ –û–ø—Ä–æ—Å –Ω–∞ {poll_day}\n"
        text += f"   üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: {send_day} –≤ {hour:02d}:{minute:02d}\n"
        if extra_options:
            options_text = ', '.join(extra_options)
            text += f"   üìù –î–æ–ø. –æ–ø—Ü–∏–∏: {options_text}\n"
        text += "\n"
    
    await message.answer(text)

@dp.message(Command("remove_days"))
async def cmd_remove_days(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π"""
    config = get_config()
    schedules = config.get('schedules', [])
    
    if not schedules:
        await message.answer("üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
        return
    
    keyboard_buttons = []
    for schedule in schedules:
        if not validate_schedule(schedule):
            continue
            
        send_day = schedule.get('send_day')
        poll_day = schedule.get('poll_day')
        send_day_name = DAY_NAMES_RU.get(send_day, send_day)
        button_text = f"{send_day_name} ‚Üí {poll_day}"
        callback_data = f"remove_{send_day}_{poll_day}"
        keyboard_buttons.append([InlineKeyboardButton(text=button_text, callback_data=callback_data)])
    
    keyboard_buttons.append([InlineKeyboardButton(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")])
    keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
    await message.answer("üóëÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=keyboard)

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –¥–Ω–µ–π ====================

@dp.callback_query(F.data.startswith("set_send_"))
async def process_send_day(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–Ω—è –æ—Ç–ø—Ä–∞–≤–∫–∏"""
    send_day = callback.data.replace("set_send_", "")
    await callback.answer()
    
    keyboard = create_poll_days_keyboard(send_day)
    day_name = DAY_NAMES_RU.get(send_day, send_day)
    await callback.message.edit_text(
        f"‚úÖ –î–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏: {day_name}\n\nüìÖ –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:",
        reply_markup=keyboard
    )

@dp.callback_query(F.data.startswith("set_poll_"))
async def process_poll_day(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–Ω—è –æ–ø—Ä–æ—Å–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏"""
    parts = callback.data.replace("set_poll_", "").split("_", 1)
    send_day = parts[0]
    poll_day = parts[1]
    await callback.answer()
    await show_time_selection(callback, send_day, poll_day, selected_hour=None)

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ ====================

async def show_time_selection(callback: CallbackQuery, send_day: str, poll_day: str, selected_hour: int = None):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã –Ω–∞ –æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ)"""
    send_day_name = DAY_NAMES_RU.get(send_day, send_day)
    keyboard_rows = []
    
    if selected_hour is None:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã (—Ç–æ–ª—å–∫–æ —Å 10 –¥–æ 20)
        hour_buttons = [
            InlineKeyboardButton(
                text=f"{hour}",
                callback_data=f"select_hour_{send_day}_{poll_day}_{hour}"
            )
            for hour in HOURS_RANGE
        ]
        
        # –†–∞–∑–±–∏–≤–∞–µ–º —á–∞—Å—ã –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 6 –∫–Ω–æ–ø–æ–∫
        for i in range(0, len(hour_buttons), 6):
            keyboard_rows.append(hour_buttons[i:i+6])
        
        text = (
            f"‚úÖ –î–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞: {send_day_name}\n"
            f"‚úÖ –î–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {poll_day}\n\n"
            f"‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Å –æ—Ç–ø—Ä–∞–≤–∫–∏:"
        )
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω—É—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Å–∞
        minute_buttons = [
            InlineKeyboardButton(
                text=f"{minute:02d}",
                callback_data=f"set_time_{send_day}_{poll_day}_{selected_hour}_{minute}"
            )
            for minute in MINUTES_OPTIONS
        ]
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –º–∏–Ω—É—Ç—ã –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ 4 –∫–Ω–æ–ø–∫–∏
        for i in range(0, len(minute_buttons), 4):
            keyboard_rows.append(minute_buttons[i:i+4])
        
        keyboard_rows.append([InlineKeyboardButton(
            text="üîÑ –ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å",
            callback_data=f"back_to_time_{send_day}_{poll_day}"
        )])
        
        text = (
            f"‚úÖ –î–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞: {send_day_name}\n"
            f"‚úÖ –î–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {poll_day}\n"
            f"‚úÖ –ß–∞—Å: {selected_hour:02d}:00\n\n"
            f"‚è∞ –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω—É—Ç—ã:"
        )
    
    keyboard_rows.append([InlineKeyboardButton(
        text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
        callback_data=f"back_to_poll_day_{send_day}"
    )])
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=keyboard_rows)
    await callback.message.edit_text(text, reply_markup=keyboard)

@dp.callback_query(F.data.startswith("select_hour_"))
async def select_hour(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Å–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É, –ø–æ–∫–∞–∑—ã–≤–∞—è –º–∏–Ω—É—Ç—ã"""
    parts = callback.data.replace("select_hour_", "").split("_")
    send_day = parts[0]
    poll_day = parts[1]
    hour = int(parts[2])
    await callback.answer()
    await show_time_selection(callback, send_day, poll_day, selected_hour=hour)

@dp.callback_query(F.data.startswith("back_to_time_"))
async def back_to_time_selection(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —á–∞—Å–∞"""
    parts = callback.data.replace("back_to_time_", "").split("_")
    send_day = parts[0]
    poll_day = parts[1]
    await callback.answer()
    await show_time_selection(callback, send_day, poll_day, selected_hour=None)

@dp.callback_query(F.data.startswith("set_time_"))
async def process_time(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å –∏ –º–∏–Ω—É—Ç—ã) –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π"""
    parts = callback.data.replace("set_time_", "").split("_")
    send_day = parts[0]
    poll_day = parts[1]
    hour = int(parts[2])
    minute = int(parts[3])
    await callback.answer()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.update_data(
        send_day=send_day,
        poll_day=poll_day,
        hour=hour,
        minute=minute
    )
    
    await show_extra_options_menu(callback, send_day, poll_day, hour, minute)

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π ====================

@dp.callback_query(F.data == "skip_extra_options")
async def skip_extra_options(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    data = await state.get_data()
    send_day = data.get('send_day')
    poll_day = data.get('poll_day')
    hour = data.get('hour')
    minute = data.get('minute')
    
    add_schedule_to_config(send_day, poll_day, hour=hour, minute=minute, extra_options=None)
    await state.clear()
    
    await callback.answer("‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!")
    await callback.message.edit_text(
        format_schedule_message(send_day, poll_day, hour, minute, extra_options=None)
    )

@dp.callback_query(F.data == "add_extra_options")
async def add_extra_options(callback: CallbackQuery, state: FSMContext):
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π"""
    await callback.answer()
    await state.set_state(ScheduleStates.waiting_for_extra_options)
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
            callback_data="back_to_extra_choice"
        )],
    ])
    
    await callback.message.edit_text(
        "üìù –í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω–Ω –¥–ª—è –æ–ø—Ä–æ—Å–∞.\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø—Ü–∏–π, —Ä–∞–∑–¥–µ–ª—è—è –∏—Ö —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π (;).\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
        "–†–µ–∑–µ—Ä–≤, —è –±—ã–ª(–∞) –≤ –ø–Ω; –î—Ä—É–≥–∞—è –æ–ø—Ü–∏—è; –¢—Ä–µ—Ç—å—è –æ–ø—Ü–∏—è\n\n",
        reply_markup=keyboard
    )

@dp.callback_query(F.data == "back_to_extra_choice")
async def back_to_extra_choice(callback: CallbackQuery, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π"""
    data = await state.get_data()
    send_day = data.get('send_day')
    poll_day = data.get('poll_day')
    hour = data.get('hour')
    minute = data.get('minute')
    
    if not all([send_day, poll_day, hour is not None, minute is not None]):
        await callback.answer("‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return
    
    await callback.answer()
    await show_extra_options_menu(callback, send_day, poll_day, hour, minute)

@dp.message(ScheduleStates.waiting_for_extra_options, Command("cancel"))
async def cancel_extra_options(message: Message, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π"""
    data = await state.get_data()
    send_day = data.get('send_day')
    poll_day = data.get('poll_day')
    hour = data.get('hour')
    minute = data.get('minute')
    
    if not all([send_day, poll_day, hour is not None, minute is not None]):
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return
    
    add_schedule_to_config(send_day, poll_day, hour=hour, minute=minute, extra_options=None)
    await state.clear()
    
    send_day_name = DAY_NAMES_RU.get(send_day, send_day)
    await message.answer(
        f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π!\n\n"
        f"üìÖ –û–ø—Ä–æ—Å –Ω–∞: {poll_day}\n"
        f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤: {send_day_name}\n"
        f"‚è∞ –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {hour:02d}:{minute:02d}"
    )

@dp.message(ScheduleStates.waiting_for_extra_options)
async def process_extra_options(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π"""
    extra_options_text = message.text.strip()
    
    if not extra_options_text:
        await message.answer("‚ùå –û–ø—Ü–∏–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞–∑–∞–¥ –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        return
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –æ–ø—Ü–∏–∏ –ø–æ —Ç–æ—á–∫–µ —Å –∑–∞–ø—è—Ç–æ–π
    options = [opt.strip() for opt in extra_options_text.split(';') if opt.strip()]
    
    if not options:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ–ø—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞–∑–∞–¥ –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        return
    
    data = await state.get_data()
    send_day = data.get('send_day')
    poll_day = data.get('poll_day')
    hour = data.get('hour')
    minute = data.get('minute')
    
    if not all([send_day, poll_day, hour is not None, minute is not None]):
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        return
    
    add_schedule_to_config(send_day, poll_day, hour=hour, minute=minute, extra_options=options)
    await state.clear()
    
    await message.answer(
        format_schedule_message(send_day, poll_day, hour, minute, extra_options=options)
    )

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è ====================

@dp.callback_query(F.data.startswith("remove_"))
async def process_remove(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    parts = callback.data.replace("remove_", "").split("_", 1)
    send_day = parts[0]
    poll_day = parts[1]
    
    remove_schedule_from_config(send_day, poll_day)
    
    send_day_name = DAY_NAMES_RU.get(send_day, send_day)
    await callback.answer(f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ: {send_day_name} ‚Üí {poll_day}")
    await callback.message.edit_text(
        f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:\nüìÖ –û–ø—Ä–æ—Å –Ω–∞ {poll_day}\nüì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ {send_day_name}"
    )

# ==================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" ====================

@dp.callback_query(F.data == "back_to_send_day")
async def back_to_send_day(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–Ω—è –æ—Ç–ø—Ä–∞–≤–∫–∏"""
    await callback.answer()
    keyboard = create_days_keyboard("set_send")
    await callback.message.edit_text("üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø—Ä–æ—Å–∞:", reply_markup=keyboard)

@dp.callback_query(F.data.startswith("back_to_poll_day_"))
async def back_to_poll_day(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É –¥–Ω—è –æ–ø—Ä–æ—Å–∞"""
    send_day = callback.data.replace("back_to_poll_day_", "")
    await callback.answer()
    
    keyboard = create_poll_days_keyboard(send_day)
    day_name = DAY_NAMES_RU.get(send_day, send_day)
    await callback.message.edit_text(
        f"‚úÖ –î–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–∫–∏: {day_name}\n\nüìÖ –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:",
        reply_markup=keyboard
    )

@dp.callback_query(F.data == "back_to_main")
async def back_to_main(callback: CallbackQuery):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é"""
    await callback.answer()
    text = (
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ —Å–∫–≤–æ—à—É.\n\n"
        "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/set_days - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–Ω–∏ –¥–ª—è –æ–ø—Ä–æ—Å–æ–≤\n"
        "/list_days - –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n"
        "/remove_days - –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
        "/help - –ü–æ–º–æ—â—å"
    )
    await callback.message.edit_text(text)

# ==================== –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ====================

async def main():
    logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
    
    setup_scheduler()
    scheduler.start()
    
    try:
        logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
        await set_commands(bot)  
        await dp.start_polling(bot)
    finally:
        await bot.close()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logging.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
